<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />
  <title>Craig-Reynolds Algorithm</title>
  <!--design-->
  <link rel="stylesheet" href="button.css" />
  <link rel="stylesheet" href="box.css" />
  <!--snippet function-->
  <script src="https://cdn.jsdelivr.net/gh/google/code-prettify@master/loader/run_prettify.js"></script>
  <link rel="stylesheet" href="desert.css" />
  <!--mouse function-->
  <script src="https://code.jquery.com/jquery-1.10.2.js"></script>
  <script src="mouse.js"></script>
  <!--main functions-->
  <script src="vector.js"></script>
  <script src="vehicle.js"></script>
  <!--sliders-->
  <script src="sliderStyle.js"></script>
  <link rel="stylesheet" href="sliderStyle.css" />
  <!--object functions -->
  <script src="object.js"></script>
  <!--To disable focusing on Chrome browser -->
  <script type="text/javascript"> //To disable focusing on Chrome browser
    document.addEventListener('click', function (e) {
      if (document.activeElement.toString() == '[object HTMLButtonElement]') { document.activeElement.blur(); }
    });
  </script>
</head>

<body>
  <div class="main_box">
    <div class="green_box">
      Simulations
    </div>
    <div class="container">
      <button class="button" onclick='window.location.href = "./00home.html"'>
        Vehicle
      </button>
    </div>
    <div class="green_box">
      Basic behaviors
    </div>
    <div class="container">
      <button class="button" onclick='window.location.href = "./01seek.html"'>
        Seek
      </button>
    </div>
    <div class="container">
      <button class="button" onclick='window.location.href = "./02flee.html"'>
        Flee
      </button>
    </div>
    <div class="container">
      <button class="button" onclick='window.location.href = "./03arrive.html"'>
        Arrival
      </button>
    </div>
    <div class="container">
      <button class="button" onclick='window.location.href = "./04pursue_evade.html"'>
        Pursue and Evade
      </button>
    </div>
    <div class="container">
      <button class="button" onclick='window.location.href = "./05wander.html"'>
        Wander
      </button>
    </div>
    <div class="container">
      <button class="button" onclick='window.location.href = "./06obstacle_avoid.html"'>
        Obstacle Avoidance
      </button>
    </div>
    <div class="container">
      <button class="button" onclick='window.location.href = "./07containment.html"'>
        Containment
      </button>
    </div>
    <div class="container">
      <button class="button" onclick='window.location.href = "./08wall_follow.html"'>
        Wall Following
      </button>
    </div>
    <div class="container">
      <button class="button" onclick='window.location.href = "./09Path_Following.html"'>
        Path Following
      </button>
    </div>
    <div class="container">
      <button class="button" onclick='window.location.href = "./10flow.html"'>
        Flow Field Following
      </button>
    </div>
    <div class="green-box">
      Combined behaviors
    </div>
    <div class="container">
      <button class="button" onclick='window.location.href = "./11CrowdPathFollow.html"'>
        Crowd Path Following
      </button>
    </div>
    <div class="container">
      <button class="button" onclick='window.location.href = "./12leader.html"'>
        Leader Following
      </button>
    </div>
    <div class="container">
      <button class="button" onclick='window.location.href = "./13unalignedAvoidence.html"'>
        Unaligned Collision Avoidance
      </button>
    </div>
    <div class="container">
      <button class="button" onclick='window.location.href = "./14queue.html"'>
        Queueing
      </button>
    </div>
    <div class="container">
      <button class="button" onclick='window.location.href = "./15flock.html"'>
        Flocking
      </button>
    </div>
  </div>

  <div class="box">

    <!--BUTTON DISPLAY FORCES-->
    <button id="Forces" class="button">
      Display Forces
    </button>

    <!--BUTTON FREEZE-->
    <button id="Freeze" class="button">
      Freeze
    </button>

  </div>

  <div class="main">

    <div class="explain_box">
      <span>
        <br>
        The <span style="color:orange">orange</span> vector pointing out of the center of Vehicle is visualization of
        the desiredVelocity and the <span style="color:#6A5ACD">violet</span>
        one shows current velocity vector.<br>
        If you wish to freeze animation you can also press a spacebar on your keyboard.
      </span>
    </div>

    <canvas id="VP" class="viewport" style="background: #eee; width: 100%;height: 50%;"></canvas>

    <div class="output_box">

      Vehicle position x:
      <span id="vehicle_posX"></span>
      y:
      <span id="vehicle_posY"></span>
      velocity:
      <span id="vehicle_vel"></span>

    </div>

    <div>

      <div class="range-slider">

        <div class="slider-box">Maxspeed</div>

        <input id="maxspeed" class="range-slider__range" type="range" value="2" min="0" max="7" step="0.01">

        <span class="range-slider__value">0</span>

      </div>

      <div class="range-slider">

        <div class="slider-box">Maxforce</div>

        <input id="maxforce" class="range-slider__range" type="range" value="0.1" min="0" max="5" step="0.01">

        <span class="range-slider__value">0</span>

      </div>

    </div>

    <div>

      <div class="range-slider">

        <div class="slider-box">Predict distance</div>

        <input id="Predict" class="range-slider__range" type="range" value="30" min="0">

        <span class="range-slider__value">0</span>

      </div>

      <div class="range-slider">

        <div class="slider-box">Target offset</div>

        <input id="Target" class="range-slider__range" type="range" value="10" min="0">

        <span class="range-slider__value">0</span>

      </div>

    </div>

    <script>

      var canvas = document.querySelector('.viewport'),
        ctx = canvas.getContext('2d');
      canvas.width = screen.width / 2;
      canvas.height = screen.height / 3;

      mouseObj.Init('#VP', canvas);

      var vehicle = new Vehicle(400, 200);
      vehicle.theta = Math.random() * 360;

      var displayForces = 'off';
      document.getElementById("Forces").addEventListener('click', function () {

        if (displayForces == 'on') {

          displayForces = 'off';

        }

        else {

          displayForces = 'on';

        }

      }, false);

      var freeze = "off";
      document.getElementById("Freeze").addEventListener('click', function freezer() {

        if (freeze == 'on') {

          freeze = 'off';
          document.getElementById("Freeze").innerHTML = "Freeze OFF";

        }

        else {

          freeze = 'on';
          document.getElementById("Freeze").innerHTML = "Freeze ON";

        }

      }, false);

      document.body.addEventListener("keypress", function (k) {

        if (k.keyCode == 32) {

          if (freeze == 'on') {

            freeze = 'off';
            document.getElementById("Freeze").innerHTML = "Freeze OFF";

          }

          else {

            freeze = 'on';
            document.getElementById("Freeze").innerHTML = "Freeze ON";

          }

        }

      }, false);

      rangeSliderInit();

      // DEFINE AND FILL ARRAY OF OBJECTS
      var objects = []

      // DEFINE AND CREATE WALL OBJECT
      function objectW(x1,y1,x2,y2){
        objects.push( new objectWall(x1,y1,x2,y2));
      }
      objectW(0,120,300,120);
      objectW(300,120,301,0);

      objectW(599,0,600,120);
      objectW(600,120,canvas.width,120);

      objectW(0,250,300,250);
      objectW(300,250,301,canvas.height);

      objectW(599,canvas.height,600,250);
      objectW(600,250,canvas.width,250);

      //DISPLAY OBJECTS ON CANVAS 
      function drawObjects(Objects) {
        for (let index = 0; index < Objects.length; index++) {
          Objects[index].draw();
        }
      }

      var target = new Vector(0, 0), timeout = 0;
      document.getElementById("VP").addEventListener('mousedown', function () {
        target = new Vector(mouseObj.x, mouseObj.y);
        timeout = 20;
      }, false);
      

      var ArrVector = [];

      //INITIAL PUSH FOR VEHICLE
      vehicle.velocity.x = vehicle.maxspeed;
      vehicle.velocity.y = vehicle.maxspeed;
      var seek = 0;

      function draw() {

        ctx.setTransform(1, 0, 0, 1, 0, 0); // <- JS magic for PathBegin()..
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        var avoid = vehicle.containment(objects,displayForces);
        if(avoid.x != 0 || avoid.y != 0){
          seek = vehicle.seek(avoid.x,avoid.y);
        }
        else{
          ArrVector = vehicle.wander(20, 20, displayForces);
          seek = vehicle.seek(ArrVector[0].x, ArrVector[0].y);
        }
        
        if (timeout > 0) {

          var seek = vehicle.seek(target.x, target.y);
          vehicle.applyForce(seek);
          timeout--;

        }


        if (freeze == "off") {

          vehicle.applyForce(seek);
          vehicle.update();

        }

        vehicle.outOfBounds();

        vehicle.renderVehicle();

        drawObjects(objects);

        if (displayForces == 'on') {

          vehicle.renderForces();

        }

        vehicle.maxforce = document.getElementById("maxforce").value;
        vehicle.maxspeed = document.getElementById("maxspeed").value;
        //path.radius = document.getElementById("Radius").value;
        $("#vehicle_posX").text(Math.ceil(vehicle.position.x));
        $("#vehicle_posY").text(Math.ceil(vehicle.position.y));
        $("#vehicle_vel").text((vehicle.velocity.length()).toFixed(2))

      }

      setInterval(draw, 50);

    </script>

  </div>

  <div class="code_box">

    <!--CREATES SNIPPET OF CODE-->
    <pre class="prettyprint linenums">
containment(Objects) {
  var mainRay = this.velocity.normalize().multiply(this.maxspeed),
  leftRay = mainRay.moveByAngle(-Math.PI / 6),
  rightRay = mainRay.moveByAngle(Math.PI / 6);
    
  mainRay = mainRay.multiply(this.radius*2);
  leftRay = leftRay.multiply(this.radius);
  rightRay = rightRay.multiply(this.radius);
    
  var mainRayPos = mainRay.add(this.position),
  leftRayPos = leftRay.add(this.position),
  rightRayPos = rightRay.add(this.position);
    
  var summedVector = new Vector(0,0);
  for (let i = 0; i < Objects.length; i++) {
    if(Objects[i].hasInside(mainRayPos,this.position)){
      var projectedPoint = Objects[i].projectedPointOnSurface(mainRayPos
      ,this.position);
      summedVector = summedVector.add( 
        Objects[i].normalVector(projectedPoint, mainRayPos) );
    }
      
    if(Objects[i].hasInside(leftRayPos,this.position)){
      var projectedPoint = Objects[i].projectedPointOnSurface(leftRayPos
      ,this.position);
      summedVector = summedVector.add(
        Objects[i].normalVector(projectedPoint, leftRayPos) );
    }
      
    if(Objects[i].hasInside(rightRayPos,this.position)){
      var projectedPoint = Objects[i].projectedPointOnSurface(rightRayPos
      ,this.position);
      summedVector = summedVector.add(
        Objects[i].normalVector(projectedPoint, rightRayPos) );
    }
  }
  if(summedVector.x != 0 || summedVector.y != 0){
    summedVector = summedVector.add(this.position);
  }     
  return summedVector;
}</pre>
  </div>
</body>

</html>