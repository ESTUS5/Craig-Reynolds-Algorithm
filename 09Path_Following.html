<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />
  <title>Craig-Reynolds Algorithm</title>
  <link rel="stylesheet" href="sliderStyle.css" />
  <link rel="stylesheet" type="text/css" href="desert.css" />
  <link rel="stylesheet" href="pagesLayoutStyle.css" />
  <link rel="stylesheet" href="button.css" />
  <script src="https://code.jquery.com/jquery-1.10.2.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/google/code-prettify@master/loader/run_prettify.js"></script>
  <script src="vector.js"></script>
  <script src="mouse.js"></script>
  <script src="vehicle.js"></script>
  <script src="sliderStyle.js"></script>
  <!--To disable focusing on Chrome browser -->
  <script type="text/javascript">
    document.addEventListener('click', function (e) {
      if (document.activeElement.toString() == '[object HTMLButtonElement]') { document.activeElement.blur(); }
    });
  </script>
  <script src="path.js"></script>
</head>

<body
  style=" background-color: hsl(117, 43%, 80%);margin-left: 0px; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif; font-size: 16px">

  <div class="box" style="float: left; width: auto; height: auto;">
    <div class="box" style="color: black; background: #53d8cd;width: 95%;height: 20px;text-align: center;
          margin-left: 0px;padding-left: 0px;padding-right: 0px;margin-bottom: 8px;">
      Simulations
    </div>

    <div class="container">
      <button class="button" onclick='window.location.href = "./00home.html"'>
        Vehicle
      </button>
    </div>

    <div class="box" style="color: black; background: #53d8cd;width: 90%;height: 20px;text-align: center;
                  margin-left: 0px;padding-left: 0px;padding-right: 0px;margin-bottom: 5px;margin-top: 5px;">
      Basic behaviors
    </div>

    <div class="container">
      <button class="button" onclick='window.location.href = "./01seek.html"'>
        Seek
      </button>
    </div>
    <div class="container">
      <button class="button" onclick='window.location.href = "./02flee.html"'>
        Flee
      </button>
    </div>
    <div class="container">
      <button class="button" onclick='window.location.href = "./03arrive.html"'>
        Arrival
      </button>
    </div>
    <div class="container">
      <button class="button" onclick='window.location.href = "./04pursue_evade.html"'>
        Pursue and Evade
      </button>
    </div>
    <div class="container">
      <button class="button" onclick='window.location.href = "./05wander.html"'>
        Wander
      </button>
    </div>
    <div class="container">
      <button class="button" onclick='window.location.href = "./06obstacle_avoid.html"'>
        Obstacle Avoidance
      </button>
    </div>
    <div class="container">
      <button class="button" onclick='window.location.href = "./07containment.html"'>
        Containment
      </button>
    </div>
    <div class="container">
      <button class="button" onclick='window.location.href = "./08wall_follow.html"'>
        Wall Following
      </button>
    </div>
    <div class="container">
      <button class="button" onclick='window.location.href = "./09Path_Following.html"'>
        Path Following
      </button>
    </div>
    <div class="container">
      <button class="button" onclick='window.location.href = "./10flow.html"'>
        Flow Field Following
      </button>
    </div>

    <div class="box" style="color: black; background: #53d8cd;width: 90%;height: 20px;text-align: center;
                  margin-left: 0px;padding-left: 0px;padding-right: 0px;margin-bottom: 5px;
                  margin-top: 5px;">
      Combined behaviors
    </div>
    <div class="container">
      <button class="button" onclick='window.location.href = "./11CrowdPathFollow.html"'>
        Crowd Path Following
      </button>
    </div>
    <div class="container">
      <button class="button" onclick='window.location.href = "./12leader.html"'>
        Leader Following
      </button>
    </div>
    <div class="container">
      <button class="button" onclick='window.location.href = "./13unalignedAvoidence.html"'>
        Unaligned Collision Avoidance
      </button>
    </div>
    <div class="container">
      <button class="button" onclick='window.location.href = "./14queue.html"'>
        Queueing
      </button>
    </div>
    <div class="container">
      <button class="button" onclick='window.location.href = "./15flock.html"'>
        Flocking
      </button>
    </div>
    </nav>
  </div>
  <div id="backToHome" class="container" style=" display: inline-block;">
    
    <!--BUTTON DISPLAY FORCES-->
    <button id="Forces" class="button">
      Display Forces
    </button>
    
    <!--BUTTON FREEZE-->
    <button id="Freeze" class="button">
      Freeze
    </button>

    <!--BUTTON RANDOM-->
    <button id="Random" class="button">
      Random the Path
    </button>

  </div>

  <div id="main" class="container" style="display: inline-block;width: 50vw;padding-right: 0px;">

      <div class="box" style="width: 90%;height:  auto;text-align: left;
        margin-bottom: 5px;">
        <span>
          &nbsp;&nbsp;The Path Following algorithm takes as input path object and returns a vector aiming on the path ahead of vehicle position.
           Calculated vector is passed down to Seek method, but the main method returns actuall target, only if Vehicle drifts away from the path.
            Essential for the algorithm is calculating normal points on paths and choosing which object is closest. It can be done in method itsefl or using methods defined for object itself.
            Second method is better, but with the first it is possible to show most of calculations done to achive goal. For example, after best normal point has been choosen, the point ahead is 
            find thanks to access to path object.
          <br>
          &nbsp;&nbsp;The <span style="color:orange">orange</span> vector pointing out of the center of Vehicle is visualization of the desiredVelocity and the <span style="color:#6A5ACD">violet</span>
          one shows current velocity vector.<br>
          &nbsp;&nbsp;If you wish to freeze animation you can also press a spacebar on your keyboard.
        </span>
      </div>
      
      <canvas id="VP" class="viewport" style="background: #eee; width: 100%; position: relative;height: 50%;"></canvas>
    
    <!--OUTPUT OF VEHICLE POSITION & VELOCITY-->
    <div class="box" style="width: 90%;height: 20px;text-align: center;
        margin-left: 0px;padding-left: 0px;padding-right: 0px;">

      Vehicle position x:
      <span id="vehicle_posX"></span>
      y:
      <span id="vehicle_posY"></span>
      velocity:
      <span id="vehicle_vel"></span>

    </div>

    <div>

      <!--RANGE SLIDER OF MAXSPEED-->
      <div id="ms" class="range-slider" style="float: left;margin-top: 20px;margin-bottom: 20px;width: 50% ;">

        <div class="box" style="margin:0px; top:4px">Maxspeed</div>

        <input id="maxspeed" class="range-slider__range" type="range" value="2" min="0" max="7" step="0.01">
        
        <span class="range-slider__value" style="top:4px">0</span>
      
      </div>

      <!--RANGE SLIDER OF MAXFORCE-->
      <div id="mf" class="range-slider" style="float: right;margin-top: 20px;margin-bottom: 20px;width: 50% ;">
        
        <div class="box" style="margin:0px; top:4px">Maxforce</div>
        
        <input id="maxforce" class="range-slider__range" type="range" value="0.1" min="0" max="5" step="0.01">
        
        <span class="range-slider__value" style="top:4px">0</span>
      
      </div>

    </div>

    <div>

      <!--RANGE SLIDER OF PREDICT DISTANCE-->
      <div id="pd" class="range-slider" style="float: left;margin-top: 20px;margin-bottom: 20px;width: 50% ;">
        
        <div class="box" style="margin:0px; top:4px">Predict distance</div>
        
        <input id="Predict" class="range-slider__range" type="range" value="30" min="0">
        
        <span class="range-slider__value" style="top:4px">0</span>
      
      </div>

      <!--RANGE SLIDER OF TARGET OFFSET-->
      <div id="to" class="range-slider" style="float: right;margin-top: 20px;margin-bottom: 20px;width: 50% ;">
        
        <div class="box" style="margin:0px; top:4px">Target offset</div>
        
        <input id="Target" class="range-slider__range" type="range" value="10" min="0">
        
        <span class="range-slider__value" style="top:4px">0</span>
      
      </div>

    </div>

    <div>

      <!--RANGE SLIDER OF PATH RADIUS/MARGIN-->
      <div id="pr" class="range-slider" style="float:left;margin-top: 20px;margin-bottom: 20px;width: 50% ;">
        
        <div class="box" style="margin:0px; top:4px">Path radius</div>
        
        <input id="Radius" class="range-slider__range" type="range" value="20" min="0">
        
        <span class="range-slider__value" style="top:4px">0</span>
      
      </div>
    
    </div>

    <script>

      //CHANGE WIDTH & HEIGHT OF CANVAS
      var canvas = document.querySelector('.viewport'),
        ctx = canvas.getContext('2d');
      canvas.width = screen.width / 2;
      canvas.height = screen.height / 3;

      //PATH INIT
      var path = new Path(0, 210, 400, 210, 20);
      path.addPoint(canvas.width + 30, 220);

      //READ IF BUTTON "RANDOM" WAS CLICKED
      var option = 'off';
      document.getElementById("Random").addEventListener('click', function () {
        option = 'on';
      }, false);

      //INIT VEHICLE
      var vehicle = new Vehicle(-30, 110);
      vehicle.choosePath(path.points, path.radius);

      //READ IF BUTTON "DISPLAY FORCE" WAS CLICKED
      var displayForces = 'off';
      document.getElementById("Forces").addEventListener('click', function () {
        if (displayForces == 'on') {
          displayForces = 'off';
        }
        else {
          displayForces = 'on';
        }
      }, false);

      //READ IF BUTTON "FREEZE" WAS CLICKED
      var freeze = "off";
      document.getElementById("Freeze").addEventListener('click', function freezer() {
        if (freeze == 'on') {
          freeze = 'off';
          document.getElementById("Freeze").innerHTML = "Freeze OFF";
        }
        else {
          freeze = 'on';
          document.getElementById("Freeze").innerHTML = "Freeze ON";
        }
      }, false);

      //READ IF BUTTON "FREEZE" WAS KEYPRESSED
      document.body.addEventListener("keypress", function (k) {
        console.log(k.keyCode, k.key, displayForces, freeze)
        if (k.keyCode == 32) {
          if (freeze == 'on') {
            freeze = 'off';
            document.getElementById("Freeze").innerHTML = "Freeze OFF";
          }
          else {
            freeze = 'on';
            document.getElementById("Freeze").innerHTML = "Freeze ON";
          }
        }
      }, false);

      rangeSliderInit();

      //LOOP FUNC
      function draw() {
        
        ctx.setTransform(1, 0, 0, 1, 0, 0); // <- JS magic for PathBegin()..
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        //RESET POSITION
        if (vehicle.position.distanceBetweenPoints(path.points[path.points.length - 1]) < path.radius) {
          vehicle.position.x = -30;
          vehicle.position.y = 110;
        }

        var follow = vehicle.followPath(document.getElementById("Predict").value,
          document.getElementById("Target").value, displayForces);
        
        if (follow.x != 0 || follow.y != 0) {
          var seek = vehicle.seek(follow.x, follow.y, displayForces);
          vehicle.applyForce(seek);
        }

        if (freeze == 'off') {
          vehicle.update();
        }

        vehicle.renderVehicle();

        path.draw();

        if (option == 'on') {

          var numberOfPoints = Math.ceil(Math.random() * 3);
          
          if (numberOfPoints == 0) {

            path = new Path(-20, Math.random() * canvas.height, canvas.width + 10, Math.random() * canvas.height, document.getElementById("Radius").value);
          
          }
          else {

            path = new Path(-10, Math.random() * canvas.height, 100 + Math.random() * 100, Math.random() * canvas.height, document.getElementById("Radius").value);
            
            for (let i = 0; i < numberOfPoints - 1; i++) {

              path.addPoint(path.points[i + 1].x + 100 + Math.random() * 200, Math.random() * canvas.height);
            
            }

            path.addPoint(canvas.width + 30, Math.random() * canvas.height);
          }

          vehicle = new Vehicle(-30, 110);
          vehicle.choosePath(path.points, path.radius);

          option = 'off';

        }

        vehicle.maxforce = document.getElementById("maxforce").value;
        vehicle.maxspeed = document.getElementById("maxspeed").value;
        vehicle.pathRadius = document.getElementById("Radius").value;
        path.radius = document.getElementById("Radius").value;

        document.getElementById("snipPredictDist").innerHTML = document.getElementById("Predict").value;
        document.getElementById("snipOffsetTarget").innerHTML = document.getElementById("Target").value;
        $("#vehicle_posX").text(Math.ceil(vehicle.position.x));
        $("#vehicle_posY").text(Math.ceil(vehicle.position.y));
        $("#vehicle_vel").text((vehicle.velocity.length()).toFixed(2))

      }

      setInterval(draw, 14);

    </script>

  </div>

    <div id="codeSnippet" class="box" style="text-align: left; display: block; width: 31vw ; margin-right: 0px;padding-right: 0px;">

      <!--CREATES SNIPPET OF CODE-->
      <pre class="prettyprint linenums"
        style="position: inherit;margin-top: 2px;margin-bottom: 2px; font-family:-apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;">
choosePath(path, radius) {
  this.path = path,
    this.pathRadius = radius,
    this.pathCurrentPoint = 0;
}
followPath(predictDistance = <b id="snipPredictDist" style="color: #cd5c5c">30</b>, targetOffset = <b id="snipOffsetTarget" style="color: #cd5c5c">10</b>,displayForces = "on") {
  var predictVehPosition = this.velocity.normalize();
  predictVehPosition = predictVehPosition.multiply(predictDistance);
  predictVehPosition = this.position.add(predictVehPosition);
  var normalPoint = new Vector(0, 0), 
    oa, ob, target, smallest_distance = Infinity;
  for (let i = 0; i < this.path.length - 1; i++) {
    var a = this.path[i];
    var b = this.path[i + 1];
    normalPoint = predictVehPosition.normalPoint(a, b);
if((normalPoint.x < Math.min(a.x,b.x)) || (normalPoint.x > Math.max(a.x,b.x))){
      normalPoint.equal(b);
    }
    var distance = predictVehPosition.distanceBetweenPoints(normalPoint);
    if (distance < smallest_distance) {
      smallest_distance = distance;
      target = normalPoint;
      oa = a;
      ob = b;
    }
  }
  var dir = ob.subtract(oa);
  dir = dir.normalize().multiply(targetOffset);
  var target_dir = target.add(dir);
  var distance = predictVehPosition.distanceBetweenPoints(target);
  if (distance > this.pathRadius) {
    return target_dir;
  }
  else{
    return new Vector(0,0);
  }
}</pre>

  </div>

</body>
</html>