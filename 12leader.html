<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />
  <title>Craig-Reynolds Algorithm</title>
  <link rel="stylesheet" href="sliderStyle.css" />
  <link rel="stylesheet" type="text/css" href="desert.css" />
  <link rel="stylesheet" href="pagesLayoutStyle.css" />
  <link rel="stylesheet" href="button.css" />
  <script src="https://code.jquery.com/jquery-1.10.2.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/google/code-prettify@master/loader/run_prettify.js"></script>
  <script src="vector.js"></script>
  <script src="mouse.js"></script>
  <script src="vehicle.js"></script>
  <script src="sliderStyle.js"></script>
  <script type="text/javascript"> //To disable focusing on Chrome browser
    document.addEventListener('click', function (e) {
      if (document.activeElement.toString() == '[object HTMLButtonElement]') { document.activeElement.blur(); }
    });
  </script>
</head>

<body style="margin:0;padding:0;overflow:hidden; background-color: hsl(117, 43%, 80%);">
  <div id="backToHome" class="container" style="width: auto px;">
    <!--BUTTON BACK TO HOME PAGE/ANCHOR-->
    <button class="button" onclick='window.location.href = "./00home.html"'>
      Back to home page
    </button>
    <!--BUTTON DISPLAY FORCES-->
    <button id="Forces" class="button">
      Display Forces
    </button>
    
    <!--BUTTON FREEZE-->
    <button id="Freeze" class="button">
      Freeze
    </button>
    <button id="followingType" class="button">
      Change Following Type
    </button>
  </div>
  <div id="main" class="container" style="float: left;width: 50%;padding-right: 0px;">
    <canvas id="VP" class="viewport" style="background: #eee; width: 100%;"></canvas>
    <div>
      <div class="range-slider" style="display: inline-block;top: 20px;">
        <div class="box">Maxspeed</div>
        <input id="maxspeed" class="range-slider__range" type="range" value="2" min="0" max="7" step="0.01">
        <span class="range-slider__value" style="left: 140px;top: -21px;">0</span>
      </div>
      <div class="range-slider" style="display: inline-block;margin-left:100px;margin-right:80px;">
        <div class="box">Maxforce</div>
        <input id="maxforce" class="range-slider__range" type="range" value="0.1" min="0" max="5" step="0.01">
        <span class="range-slider__value" style="left: 140px;top: -21px;">0</span>
      </div>
    </div>
    <div>
      <div class="range-slider" style="display: inline-block;margin-left:100px;margin-right:80px;">
        <div class="box">Target offset</div>
        <input id="Target" class="range-slider__range" type="range" value="10" min="0">
        <span class="range-slider__value" style="left: 140px;top: -21px;">0</span>
      </div>
    </div>
    <script>
      var canvas = document.querySelector('.viewport'),
      ctx = canvas.getContext('2d');
      canvas.width = screen.width / 2;
      canvas.height = 400;
      mouseObj.Init('#VP');
      var vehicles = [];
      for (let index = 0; index < 10; index++) {
        vehicles.push(new Vehicle(Math.ceil(Math.random() * 800), Math.ceil(Math.random() * 400)));
        vehicles[vehicles.length - 1].radius = 5;
      }
      var displayForces = 'off';
      document.getElementById("Forces").addEventListener('click', function () {
        if (displayForces == 'on') {
          displayForces = 'off';
        }
        else {
          displayForces = 'on';
        }
      }, false);
      var followingType = 'line';
      document.getElementById("followingType").addEventListener('click', function () {
        if (followingType == 'line') {
          followingType = 'group';
        }
        else {
          followingType = 'line';
        }
      }, false);
            var freeze = "off";
      document.getElementById("Freeze").addEventListener('click', function freezer() {
        if (freeze == 'on') {
          freeze = 'off';
          document.getElementById("Freeze").innerHTML = "Freeze OFF";
        }
        else {
          freeze = 'on';
          document.getElementById("Freeze").innerHTML = "Freeze ON";
        }
      }, false);
      document.body.addEventListener("keypress", function (k) {
        console.log(k.keyCode, k.key, displayForces, freeze)
        if (k.keyCode == 32) {
          if (freeze == 'on') {
            freeze = 'off';
            document.getElementById("Freeze").innerHTML = "Freeze OFF";
          }
          else {
            freeze = 'on';
            document.getElementById("Freeze").innerHTML = "Freeze ON";
          }
        }
      }, false);
      rangeSliderInit();
      function draw() {
        ctx.setTransform(1, 0, 0, 1, 0, 0); // <- JS magic for PathBegin()..
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        if(followingType == 'line'){
          for (let index = 1; index < vehicles.length; index++) {
            vehicles[index].follow(vehicles[index - 1],offset=vehicles[index].radius*3,displayForces)
            vehicles[index].separation(vehicles);
            if (freeze == 'off') {
          vehicles[index].update();
        }
            vehicles[index].renderVehicle();
            vehicles[index].maxforce = document.getElementById("maxforce").value;
            vehicles[index].maxspeed = document.getElementById("maxspeed").value;
          }
          vehicles[0].arrival(mouseObj.x, mouseObj.y,displayForces);
          vehicles[0].separation(vehicles);
          vehicles[0].update();
          vehicles[0].renderVehicle();
          vehicles[0].maxforce = document.getElementById("maxforce").value;
          vehicles[0].maxspeed = document.getElementById("maxspeed").value;
        }
        else if(followingType == 'group'){
          for (let index = 1; index < vehicles.length; index++) {
            vehicles[index].follow(vehicles[0],offset=vehicles[index].radius*3,displayForces)
            vehicles[index].separation(vehicles);
            if (freeze == 'off') {
          vehicles[index].update();
        }
            vehicles[index].renderVehicle();
            vehicles[index].maxforce = document.getElementById("maxforce").value;
            vehicles[index].maxspeed = document.getElementById("maxspeed").value;
          }
          vehicles[0].arrival(mouseObj.x, mouseObj.y,displayForces);
          vehicles[0].separation(vehicles);
          vehicles[0].update();
          vehicles[0].renderVehicle();
          vehicles[0].maxforce = document.getElementById("maxforce").value;
          vehicles[0].maxspeed = document.getElementById("maxspeed").value;  
        }
          //vehicle.maxforce = document.getElementById("maxforce").value;
        //vehicle.maxspeed = document.getElementById("maxspeed").value;
        //path.radius = document.getElementById("Radius").value;
        //$("#vehicle_posX").text(Math.ceil(vehicle.position.x));
        //$("#vehicle_posY").text(Math.ceil(vehicle.position.y));
        //$("#vehicle_vel").text((vehicle.velocity.length()).toFixed(2))
      }
      setInterval(draw, 14);
    </script>
  </div>
  <div id="codeSnippet" class="container" style="float: right; width: 49%; margin: 2px;">
    <pre class="prettyprint linenums" style="position: inherit;margin-top: 0px;margin-bottom: 0px;">
separation(Vehicles) {
  var desired_seperation = this.radius * 2;
  var sumVector = new Vector(0, 0);
  var j = 0;
  for (let i = 0; i < Vehicles.length; i++) {
    var distance = this.position.distanceBetweenPoints(Vehicles[i].position);
    if ((distance > 0) && (distance < desired_seperation)) {
      var differance = this.position.subtract(Vehicles[i].position);
      differance = differance.normalize();
      differance = differance.divide(distance);
      sumVector = sumVector.add(differance);
      j++;
    }
  }
  if (j > 0) {
    sumVector = sumVector.divide(j);
    sumVector = sumVector.normalize();
    sumVector = sumVector.multiply(this.maxspeed);
    var steer = sumVector.subtract(this.velocity);
    this.applyForce(steer);
    }
}</pre>
        <pre class="prettyprint linenums" style="position: relative;margin-top: 2px;margin-bottom: 0px;margin-right: 0px">
if(followingType == 'line'){
  for (let index = 1; index < vehicles.length; index++) {
    vehicles[index].follow(vehicles[index - 1])
    vehicles[index].separation(vehicles);
    vehicles[index].update();
    vehicles[index].renderVehicle();
  }
  vehicles[0].arrival(mouseObj.x, mouseObj.y.displayForces);
  vehicles[0].separation(vehicles);
  vehicles[0].update();
  vehicles[0].renderVehicle();
}
else if(followingType == 'group'){
  for (let index = 1; index < vehicles.length; index++) {
    vehicles[index].follow(vehicles[0])
    vehicles[index].separation(vehicles);
    vehicles[index].update();
    vehicles[index].renderVehicle();
  }
  vehicles[0].arrival(mouseObj.x, mouseObj.y,displayForces);
  vehicles[0].separation(vehicles);
  vehicles[0].update();
  vehicles[0].renderVehicle();  
}</pre>
  </div>
</body>

</html>