<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />
  <title>Craig-Reynolds Algorithm</title>
  <link rel="stylesheet" href="sliderStyle.css" />
  <link rel="stylesheet" type="text/css" href="desert.css" />
  <link rel="stylesheet" href="pagesLayoutStyle.css" />
  <link rel="stylesheet" href="button.css" />
  <script src="https://code.jquery.com/jquery-1.10.2.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/google/code-prettify@master/loader/run_prettify.js"></script>
  <script src="vector.js"></script>
  <script src="mouse.js"></script>
  <script src="vehicle.js"></script>
  <script src="sliderStyle.js"></script>

  <script type="text/javascript">
    document.addEventListener('click', function (e) {
      if (document.activeElement.toString() == '[object HTMLButtonElement]') { document.activeElement.blur(); }
    });
  </script>
</head>

<body
  style=" background-color: hsl(117, 43%, 80%);padding-right: 0;margin-right: 0;margin-left: 0px; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif; font-size: 16px">

  <div class="box" style="float: left; width: auto vw; font-size: 90%; height: auto;">
    <div class="box" style="color: black; background: #53d8cd;width: 95%;height: 90%;text-align: center;
          margin-left: 0px;padding-left: 0px;padding-right: 0px;margin-bottom: 8px;">
      Simulations
    </div>

    <div class="container">
      <button class="button" onclick='window.location.href = "./00home.html"'>
        Vehicle
      </button>
    </div>

    <div class="box" style="color: black; background: #53d8cd;width: 90%;height: 90%;text-align: center;
                  margin-left: 0px;padding-left: 0px;padding-right: 0px;margin-bottom: 5px;margin-top: 5px;">
      Basic behaviors
    </div>

    <div class="container">
      <button class="button" onclick='window.location.href = "./01seek.html"'>
        Seek
      </button>
    </div>
    <div class="container">
      <button class="button" onclick='window.location.href = "./02flee.html"'>
        Flee
      </button>
    </div>
    <div class="container">
      <button class="button" onclick='window.location.href = "./03arrive.html"'>
        Arrival
      </button>
    </div>
    <div class="container">
      <button class="button" onclick='window.location.href = "./04pursue_evade.html"'>
        Pursue and Evade
      </button>
    </div>
    <div class="container">
      <button class="button" onclick='window.location.href = "./05wander.html"'>
        Wander
      </button>
    </div>
    <div class="container">
      <button class="button" onclick='window.location.href = "./06obstacle_avoid.html"'>
        Obstacle Avoidance
      </button>
    </div>
    <div class="container">
      <button class="button" onclick='window.location.href = "./07containment.html"'>
        Containment
      </button>
    </div>
    <div class="container">
      <button class="button" onclick='window.location.href = "./08wall_follow.html"'>
        Wall Following
      </button>
    </div>
    <div class="container">
      <button class="button" onclick='window.location.href = "./09Path_Following.html"'>
        Path Following
      </button>
    </div>
    <div class="container">
      <button class="button" onclick='window.location.href = "./10flow.html"'>
        Flow Field Following
      </button>
    </div>

    <div class="box" style="color: black; background: #53d8cd;width: 90%;height: 90%;text-align: center;
                  margin-left: 0px;padding-left: 0px;padding-right: 0px;margin-bottom: 5px;
                  margin-top: 5px;">
      Combined behaviors
    </div>
    <div class="container">
      <button class="button" onclick='window.location.href = "./11CrowdPathFollow.html"'>
        Crowd Path Following
      </button>
    </div>
    <div class="container">
      <button class="button" onclick='window.location.href = "./12leader.html"'>
        Leader Following
      </button>
    </div>
    <div class="container">
      <button class="button" onclick='window.location.href = "./13unalignedAvoidence.html"'>
        Unaligned Collision Avoidance
      </button>
    </div>
    <div class="container">
      <button class="button" onclick='window.location.href = "./14queue.html"'>
        Queueing
      </button>
    </div>
    <div class="container">
      <button class="button" onclick='window.location.href = "./15flock.html"'>
        Flocking
      </button>
    </div>
    </nav>
  </div>

  <div id="backToHome" class="container" style=" display: inline-block;">

    <!--BUTTON DISPLAY FORCES-->
    <button id="Forces" class="button">
      Display Forces
    </button>
    
    <!--BUTTON FREEZE-->
    <button id="Freeze" class="button">
      Freeze
    </button>

    <!--BUTTON CHANGE FOLLOWING TYPE-->
    <button id="followingType" class="button">
      Change Following Type
    </button>

  </div>

  <div id="main" class="container" style="display: inline-block;width: 48vw;padding-right: 0px;">

      <div class="box" style="width: 90%;height:  auto;text-align: left;
        margin-bottom: 5px;">
        <span>
          &nbsp;&nbsp;The Leader Following algorithm is a method that "predicts" past position of leader (target) and the Arrives to that point.
          Beside following, the space in front of leader is being always checked by the vehicle (follower).
           If it finds itself in the <span style="color:rgba(50, 155, 50, 0.767)">green</span> space the next target is normal vector from that area.
          <br>
          &nbsp;&nbsp;The <span style="color:orange">orange</span> vector pointing out of the center of Vehicle is visualization of the desiredVelocity and the <span style="color:#6A5ACD">violet</span>
          one shows current velocity vector. The <span style="color:rgba(50, 155, 50, 0.767)">green</span> space 
          is an area that follower will be escaping. The <span style="color:rgba(192, 49, 49, 0.767)">red</span> vector represents target position<br>
          &nbsp;&nbsp;If you wish to freeze animation you can also press a spacebar on your keyboard.
        </span>
      </div>

      <canvas id="VP" class="viewport" style="background: #eee; width: 100%; position: relative;height: 50%;"></canvas>

    <div>

      <div class="range-slider" style="float: left;margin-top: 20px;margin-bottom: 20px;width: 50% ;">

        <div class="box" style="margin:0px; top:4px">Maxspeed</div>

        <input id="maxspeed" class="range-slider__range" type="range" value="2" min="0" max="7" step="0.01">
        
        <span class="range-slider__value" style="top:4px">0</span>
      
      </div>

      <div class="range-slider" style="float: left;margin-top: 20px;margin-bottom: 20px;width: 50% ;">
        
        <div class="box" style="margin:0px; top:4px">Maxforce</div>
        
        <input id="maxforce" class="range-slider__range" type="range" value="0.1" min="0" max="5" step="0.01">
        
        <span class="range-slider__value" style="top:4px">0</span>
      
      </div>
    
    </div>

    <div>

      <div class="range-slider" style="float: left;margin-top: 20px;margin-bottom: 20px;width: 50% ;">
        
        <div class="box" style="margin:0px; top:4px">Target offset</div>
        
        <input id="offset" class="range-slider__range" type="range" value="30" min="0.1">
        
        <span class="range-slider__value" style="top:4px">0</span>
      
      </div>

      <div class="range-slider" style="float: left;margin-top: 20px;margin-bottom: 20px;width: 50% ;">
        
          <div class="box" style="margin:0px; top:4px">Length of green area</div>
          
          <input id="predist" class="range-slider__range" type="range" value="30" min="0.1">
          
          <span class="range-slider__value" style="top:4px">0</span>
        
        </div>

        <div class="range-slider" style="float: left;margin-top: 20px;margin-bottom: 20px;width: 50% ;">
        
            <div class="box" style="margin:0px; top:4px">Margin of green area</div>
            
            <input id="radius" class="range-slider__range" type="range" value="10" min="0.1">
            
            <span class="range-slider__value" style="top:4px">0</span>
          
          </div>
    
    </div>
    
    <script>


      var canvas = document.querySelector('.viewport'),
      ctx = canvas.getContext('2d');
      canvas.width = screen.width / 2;
      canvas.height = screen.height / 3;


      mouseObj.Init('#VP',canvas);


      var vehicles = [];
      for (let index = 0; index < 10; index++) {
        vehicles.push(new Vehicle(Math.ceil(Math.random() * 800), Math.ceil(Math.random() * 400)));
        vehicles[vehicles.length - 1].radius = 10;
      }


      var displayForces = 'off';
      document.getElementById("Forces").addEventListener('click', function () {
        if (displayForces == 'on') {
          displayForces = 'off';
        }
        else {
          displayForces = 'on';
        }
      }, false);


      var followingType = 'line';
      document.getElementById("followingType").addEventListener('click', function () {
        if (followingType == 'line') {
          followingType = 'group';
        }
        else {
          followingType = 'line';
        }
      }, false);


      var freeze = "off";
      document.getElementById("Freeze").addEventListener('click', function freezer() {
        if (freeze == 'on') {
          freeze = 'off';
          document.getElementById("Freeze").innerHTML = "Freeze OFF";
        }
        else {
          freeze = 'on';
          document.getElementById("Freeze").innerHTML = "Freeze ON";
        }
      }, false);


      document.body.addEventListener("keypress", function (k) {
        console.log(k.keyCode, k.key, displayForces, freeze)
        if (k.keyCode == 32) {
          if (freeze == 'on') {
            freeze = 'off';
            document.getElementById("Freeze").innerHTML = "Freeze OFF";
          }
          else {
            freeze = 'on';
            document.getElementById("Freeze").innerHTML = "Freeze ON";
          }
        }
      }, false);


      rangeSliderInit();


      function draw() {

        ctx.setTransform(1, 0, 0, 1, 0, 0); // <- JS magic for PathBegin()..
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        if(followingType == 'line'){

          for (let index = 1; index < vehicles.length; index++) {

            var leader = vehicles[index].followLeader(vehicles[index - 1],
            offset= document.getElementById("offset").value,
            preDistance = document.getElementById("predist").value,
            radius = document.getElementById("radius").value,
            displayForces)
            var separation = vehicles[index].separation(vehicles);
            var arr = vehicles[index].arrival(leader.x,leader.y,30,displayForces);
            vehicles[index].applyForce(arr);
            vehicles[index].applyForce(separation);
            if (freeze == 'off') {
              vehicles[index].update();
            }

            vehicles[index].renderVehicle();
            vehicles[index].maxforce = document.getElementById("maxforce").value;
            vehicles[index].maxspeed = document.getElementById("maxspeed").value;
            
          }

          var arriv = vehicles[0].arrival(mouseObj.x, mouseObj.y,30,displayForces);
          var separation = vehicles[0].separation(vehicles);
          vehicles[0].applyForce(arriv);
          vehicles[0].applyForce(separation);
          vehicles[0].update();
          vehicles[0].renderVehicle();
          vehicles[0].maxforce = document.getElementById("maxforce").value;
          vehicles[0].maxspeed = document.getElementById("maxspeed").value;

        }
        else if(followingType == 'group'){

          for (let index = 1; index < vehicles.length; index++) {

            var leader = vehicles[index].followLeader(vehicles[0],
              offset= document.getElementById("offset").value,
              preDistance = document.getElementById("predist").value,
              radius = document.getElementById("radius").value,
              displayForces)
            var separation = vehicles[index].separation(vehicles);
            var arr = vehicles[index].arrival(leader.x,leader.y,30,displayForces);
            vehicles[index].applyForce(arr);
            vehicles[index].applyForce(separation);

            if (freeze == 'off') {
              vehicles[index].update();
            }

            vehicles[index].renderVehicle();
            vehicles[index].maxforce = document.getElementById("maxforce").value;
            vehicles[index].maxspeed = document.getElementById("maxspeed").value;

          }

          var arriv = vehicles[0].arrival(mouseObj.x, mouseObj.y,30,displayForces);
          var separation = vehicles[0].separation(vehicles);
          vehicles[0].applyForce(arriv);
          vehicles[0].applyForce(separation);
          vehicles[0].update();
          vehicles[0].renderVehicle();
          vehicles[0].maxforce = document.getElementById("maxforce").value;
          vehicles[0].maxspeed = document.getElementById("maxspeed").value;

        }

      }

      setInterval(draw, 14);

    </script>

  </div>

  <div id="codeSnippet" class="box" style="text-align: left; display: block; width: 34.5vw; margin-right: 0px;padding-right: 0px;">

      <!--CREATES SNIPPET OF CODE-->
      <pre class="prettyprint linenums"
        style="font-size:90%;position: inherit;margin-top: 2px;margin-bottom: 2px; font-family:-apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;">
followLeader(Vehicle, offset,predDistance, radius) {
  var predictedPosition = Vehicle.velocity.normalize();
  predictedPosition = predictedPosition.multiply(predDistance*2);
  predictedPosition = predictedPosition.add(Vehicle.position);
  var normalPoint = this.position.normalPoint(Vehicle.position,predictedPosition);
  if(this.position.isBetween(Vehicle.position,predictedPosition)){
    var steerAway = this.position.subtract(normalPoint);
    steerAway = steerAway.normalize().multiply(100);
    steerAway = steerAway.add(this.position);
    return steerAway;
  }
  else{
    var target = Vehicle.velocity.normalize().multiply(-1.3);
    target = target.multiply(offset);
    target = target.add(Vehicle.position)
    return target;
  }
}</pre>

  </div>

</body>

</html>