<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title>Craig-Reynolds Algorithm</title>
    <!--design-->
    <link rel="stylesheet" href="button.css" />
    <link rel="stylesheet" href="box.css" />
    <!--snippet function-->
    <script src="https://cdn.jsdelivr.net/gh/google/code-prettify@master/loader/run_prettify.js"></script>
    <link rel="stylesheet" href="desert.css" />
    <!--mouse function-->
    <script src="https://code.jquery.com/jquery-1.10.2.js"></script>
    <script src="mouse.js"></script>
    <!--main functions-->
    <script src="vector.js"></script>
    <script src="vehicle.js"></script>
    <!--sliders-->
    <script src="sliderStyle.js"></script>
    <link rel="stylesheet" href="sliderStyle.css" />
    <!--To disable focusing on Chrome browser -->
    <script type="text/javascript">
        document.addEventListener('click', function (e) {
            if (document.activeElement.toString() == '[object HTMLButtonElement]') { document.activeElement.blur(); }
        });
    </script>
</head>

<body>
    <div class="menu_box">
        <div class="green_box">
        Simulations
        </div>

        <div class="container">
        <button class="button" onclick='window.location.href = "./00home.html"'>
            Vehicle
        </button>
        </div>

        <div class="green_box">
        Basic behaviors
        </div>

        <div class="container">
        <button class="button" onclick='window.location.href = "./01seek.html"'>
            Seek
        </button>
        </div>
        <div class="container">
        <button class="button" onclick='window.location.href = "./02flee.html"'>
            Flee
        </button>
        </div>
        <div class="container">
        <button class="button" onclick='window.location.href = "./03arrive.html"'>
            Arrival
        </button>
        </div>
        <div class="container">
        <button class="button" onclick='window.location.href = "./04pursue_evade.html"'>
            Pursue and Evade
        </button>
        </div>
        <div class="container">
        <button class="button" onclick='window.location.href = "./05wander.html"'>
            Wander
        </button>
        </div>
        <div class="container">
        <button class="button" onclick='window.location.href = "./06obstacle_avoid.html"'>
            Obstacle Avoidance
        </button>
        </div>
        <div class="container">
        <button class="button" onclick='window.location.href = "./07containment.html"'>
            Containment
        </button>
        </div>
        <div class="container">
        <button class="button" onclick='window.location.href = "./08wall_follow.html"'>
            Wall Following
        </button>
        </div>
        <div class="container">
        <button class="button" onclick='window.location.href = "./09Path_Following.html"'>
            Path Following
        </button>
        </div>
        <div class="container">
        <button class="button" onclick='window.location.href = "./10flow.html"'>
            Flow Field Following
        </button>
        </div>

        <div class="green_box">
        Combined behaviors
        </div>
        <div class="container">
        <button class="button" onclick='window.location.href = "./11CrowdPathFollow.html"'>
            Crowd Path Following
        </button>
        </div>
        <div class="container">
        <button class="button" onclick='window.location.href = "./12leader.html"'>
            Leader Following
        </button>
        </div>
        <div class="container">
        <button class="button" onclick='window.location.href = "./13unalignedAvoidence.html"'>
            Unaligned Collision Avoidance
        </button>
        </div>
        <div class="container">
        <button class="button" onclick='window.location.href = "./14queue.html"'>
            Queueing
        </button>
        </div>
        <div class="container">
        <button class="button" onclick='window.location.href = "./15flock.html"'>
            Flocking
        </button>
        </div>
        </nav>
    </div>

    <div class="box">

        <!--BUTTON DISPLAY FORCES-->
        <button id="Forces" class="button">
            Display Forces
        </button>
            
        <!--BUTTON FREEZE-->
        <button id="Freeze" class="button">
            Freeze
        </button>

        <!--BUTTON CHANGE ALGORITHM -->
        <button id="change" class="button">
            Pursue
        </button>

    </div>

    <div class="main">
        
        <div class="explain_box">
            <span>&nbsp;&nbsp;Pursue and Evade are two very similar methods. If Flee is inverse of Seek, then the same is Evade for Pursue.
                 Idea behind methods is quite simple, but with a falws.
                 The <span style="color:#cd5c5c">red</span> vehicle is the one using one or another method.
                  He will check current velocity and position of his target and predict when they will be able to overlap.
                  Then the vehicle will seek to that direction.
                 The methods itself are not robust and can be tricked and to show that the positions of vehicles and theirs atrributes will change randomly.<br>
                &nbsp;&nbsp;The <span style="color:#FF4500">orange</span> vector pointing out of the center of Vehicle is visualization of the desiredVelocity and the <span style="color:#6A5ACD">violet</span>
                one shows current velocity vector. The <span style="color:rgba(73, 131, 103, 0.795)">green with circle</span> describes the point of collision between two.<br>
                &nbsp;&nbsp;If you wish to freeze animation you can also press a spacebar on your keyboard and you can manually change the target of prey by clicking on the canvas with left mouse button on your desired position.
            </span>
        </div>

        <canvas id="VP" class="viewport" style="background: #eee; width: 100%;height: 50%;"></canvas>

        <!--OUTPUT OF MOUSE POSITIONS OF CANVAS-->
        <div class="output_box">

            Red <span name="red">Pursuer</span> position x:
            <span id="pursuer_posX"></span>
            y:
            <span id="pursuer_posY"></span>
            velocity :
            <span id="pursuer_vel"></span>

        </div>

        <!--OUTPUT OF VEHICLE POSITION & VELOCITY-->
        <div class="output_box">

            Blue <span name="blue">Target</span> position x:
            <span id="evader_posX"></span>
            y:
            <span id="evader_posY"></span>
            velocity :
            <span id="evader_vel"></span>

        </div>

        <div>

            <!--RANGE SLIDER OF MAXSPEED OF PURSUER/CHASER-->
            <div class="range-slider">

                <div class="slider-box">
                    Maxspeed of <span name="red">Pursuer</span>
                </div>
                <div class="container">
                <input id="maxspeed1" class="range-slider__range" type="range" min="0" max="7" step="0.01">
            
                <span id="span1a" class="range-slider__value">
                    0
                </span>
                </div>
            </div>

            <!--RANGE SLIDER OF MAXFORCE PURSUER/CHASER-->
            <div class="range-slider">
                
                <div class="slider-box">
                    Maxforce of <span name="red">Pursuer</span>
                </div>
                <div class="container">
                <input id="maxforce1" class="range-slider__range" type="range" min="0" max="5" step="0.01">
                
                <span id="span1b" class="range-slider__value">
                    0
                </span>
                </div>
            </div>

        </div>

        <div>

            <!--RANGE SLIDER OF MAXSPEED TARGET/EVADER-->
            <div class="range-slider">

                <div class="slider-box">
                    Maxspeed of <span name="blue">Target</span>
                </div>
                <div class="container">
                <input id="maxspeed2" class="range-slider__range" type="range" min="0" max="7" step="0.01">
                
                <span id="span2a" class="range-slider__value">
                    0
                </span>
                </div>
            </div>

            <!--RANGE SLIDER OF MAXFORCE TARGET/EVADER-->
            <div class="range-slider">
                
                <div class="slider-box">
                    Maxforce of <span name="blue">Target</span>
                </div>
                <div class="container">
                <input id="maxforce2" class="range-slider__range" type="range" min="0" max="5" step="0.01">
                
                <span id="span2b" class="range-slider__value">
                    0
                </span>
                </div>
            </div>
            
        </div>

        <script>
            //CHANGE WIDTH & HEIGHT OF CANVAS
            var canvas = document.querySelector('.viewport'),
                ctx = canvas.getContext('2d');
          canvas.width = screen.width / 2;
          canvas.height = screen.height/3;

            //INIT MOUSE POS
            mouseObj.Init("#VP",canvas);


            // SET RANDOM VALUES FOR VEHICLES
            document.getElementById("maxspeed1").value = 1 + Math.random() * 5;
            document.getElementById("maxspeed2").value = 1 + Math.random() * 5;
            document.getElementById("span1a").textContent = document.getElementById("maxspeed1").value;
            document.getElementById("span1b").textContent = document.getElementById("maxforce1").value;
            document.getElementById("span2a").textContent = document.getElementById("maxspeed2").value;
            document.getElementById("span2b").textContent = document.getElementById("maxforce2").value;

            //INIT VEHICLE
            var vehicle = new Vehicle(Math.random() * canvas.width/2, Math.random() * canvas.height/2);
            var vehicle2 = new Vehicle(Math.random() * canvas.width/2,( Math.random() * canvas.height/2) + (canvas.height/2));
            var randomTarget = new Vector(Math.ceil(Math.random() * canvas.width/2) + (canvas.width/2), Math.ceil(Math.random() * canvas.height/2) + (canvas.height/2));

            //READ IF BUTTON "PURSUE/EVADER" WAS CLICKED
            var option = 'pursuer';
            document.getElementById("change").addEventListener('click', function () {
                if (option == 'pursuer') {
                    option = 'evader';
                    document.getElementById("change").textContent = 'Evade';
                }
                else if (option == 'evader') {
                    option = 'pursuer';
                    document.getElementById("change").textContent = 'Pursue';
                }
            }, false);
            
            //READ IF BUTTON "DISPLAY FORCE" WAS CLICKED
            var displayForces = 'off';
            document.getElementById("Forces").addEventListener('click', function () {
                if (displayForces == 'on') {
                    displayForces = 'off';
                }
                else {
                    displayForces = 'on';
                }
            }, false);

            //READ IF BUTTON "FREEZE" WAS CLICKED
            var freeze = "off";
            document.getElementById("Freeze").addEventListener('click', function freezer() {
                if (freeze == 'on') {
                freeze = 'off';
                document.getElementById("Freeze").innerHTML = "Freeze OFF";
                }
                else {
                freeze = 'on';
                document.getElementById("Freeze").innerHTML = "Freeze ON";
                }
            }, false);

            //READ IF BUTTON "FREEZE" WAS KEYPRESSED
            document.body.addEventListener("keypress", function (k) {
                if (k.keyCode == 32) {
                if (freeze == 'on') {
                    freeze = 'off';
                    document.getElementById("Freeze").innerHTML = "Freeze OFF";
                }
                else {
                    freeze = 'on';
                    document.getElementById("Freeze").innerHTML = "Freeze ON";
                }
                }
            }, false);

            rangeSliderInit();

            //LOOP FUNC
            let i = 0;
            function draw() {
                if (vehicle.position.distanceBetweenPoints(vehicle2.position) < 5) {

                    // SET RANDOM VALUES FOR VEHICLES
                    document.getElementById("maxspeed1").value = 1 + Math.random() * 5;
                    document.getElementById("maxspeed2").value = 1 + Math.random() * 5;
                    document.getElementById("span1a").textContent = document.getElementById("maxspeed1").value;
                    document.getElementById("span1b").textContent = document.getElementById("maxforce1").value;
                    document.getElementById("span2a").textContent = document.getElementById("maxspeed2").value;
                    document.getElementById("span2b").textContent = document.getElementById("maxforce2").value;

                    //INIT VEHICLE
                    vehicle = new Vehicle(Math.random() * canvas.width/2, Math.random() * canvas.height/2);
                    vehicle2 = new Vehicle(Math.random() * canvas.width/2,( Math.random() * canvas.height/2) + (canvas.height/2));
                    randomTarget = new Vector(Math.ceil(Math.random() * canvas.width/2) + (canvas.width/2), Math.ceil(Math.random() * canvas.height/2));
                }
                
                document.getElementById("VP").addEventListener('mousedown', function () {
                    randomTarget = new Vector(mouseObj.x, mouseObj.y);
                }, false);

                ctx.setTransform(1, 0, 0, 1, 0, 0); // <- JS magic for PathBegin()..
                ctx.clearRect(0, 0, canvas.width, canvas.height);

                var r = document.getElementsByName("red"),
                    b = document.getElementsByName("blue");

                if (option === 'pursuer') {
                    var pursue = vehicle.pursue(vehicle2.position, vehicle2.velocity, displayForces),
                    seek = vehicle2.seek(randomTarget.x, randomTarget.y, displayForces);
                    var seekPursue = vehicle.seek(pursue.x,pursue.y);
                    vehicle.applyForce(seekPursue);
                    vehicle2.applyForce(seek);
                    for (let index = 0; index < r.length; index++) {
                        r[index].innerHTML = 'Pursuer';
                        b[index].innerHTML = 'Target';
                    }
                }

                else {
                    var evade = vehicle.evade(vehicle2.position, vehicle2.velocity, displayForces);
                    var fleeEvade = vehicle.flee(100,evade.x,evade.y,displayForces);
                    var arrival = vehicle2.arrival(vehicle.position.x, vehicle.position.y,5);
                    vehicle.applyForce(fleeEvade);
                    vehicle2.applyForce(arrival);
                    for (let index = 0; index < r.length; index++) {
                        r[index].innerHTML = 'Evader';
                        b[index].innerHTML = 'Seeker';
                    }
                }
                if(displayForces == "on"){
                        vehicle2.renderForces();
                        vehicle.renderForces();
                    }
                vehicle.onlyCanvas();
                vehicle2.onlyCanvas();
               
               if (freeze == 'off') {
                    vehicle.update();
                    vehicle2.update();
                }

                vehicle.renderVehicle(colour = 'rgba(200,0,0,0.5)');
                vehicle2.renderVehicle();

                vehicle.maxforce = document.getElementById("maxforce1").value;
                vehicle.maxspeed = document.getElementById("maxspeed1").value;
                vehicle2.maxforce = document.getElementById("maxforce2").value;
                vehicle2.maxspeed = document.getElementById("maxspeed2").value;

                $("#pursuer_posX").text(Math.ceil(vehicle.position.x));
                $("#pursuer_posY").text(Math.ceil(vehicle.position.y));
                $("#pursuer_vel").text(vehicle.velocity.length().toFixed(2));
                $("#evader_posX").text(Math.ceil(vehicle2.position.x));
                $("#evader_posY").text(Math.ceil(vehicle2.position.y));
                $("#evader_vel").text(vehicle2.velocity.length().toFixed(2));
            }
            setInterval(draw, 50);
        </script>

    </div>

    <div class="code_box">

        <!--CREATES SNIPPET OF CODE-->
        <pre class="prettyprint linenums">
pursue(target_position, target_velocity) {
  var distance = this.position.distanceBetweenPoints(target_position);
  var predictedTargetPosition = distance / this.maxspeed;
  var target = target_position.add(target_velocity.multiply(predictedTargetPosition))
  return target;
}
evade(target_position, target_velocity) {
  var distance = this.position.distanceBetweenPoints(target_position);
  var predictedTargetPosition = distance / this.maxspeed;
  var target = target_position.add(target_velocity.multiply(predictedTargetPosition))
  return target;
}</pre>
    </div>
</body>
</html>