<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title>Craig-Reynolds Algorithm</title>
    <!--design-->
    <link rel="stylesheet" href="button.css" />
    <link rel="stylesheet" href="box.css" />
    <!--snippet function-->
    <script src="https://cdn.jsdelivr.net/gh/google/code-prettify@master/loader/run_prettify.js"></script>
    <link rel="stylesheet" href="desert.css" />
    <!--mouse function-->
    <script src="https://code.jquery.com/jquery-1.10.2.js"></script>
    <script src="mouse.js"></script>
    <!--main functions-->
    <script src="vector.js"></script>
    <script src="vehicle.js"></script>
    <!--sliders-->
    <script src="sliderStyle.js"></script>
    <link rel="stylesheet" href="sliderStyle.css" />
    <!--object functions -->
    <script src="object.js"></script>
    <!--To disable focusing on Chrome browser -->
  <script type="text/javascript"> //To disable focusing on Chrome browser
    document.addEventListener('click', function (e) {
      if (document.activeElement.toString() == '[object HTMLButtonElement]') { document.activeElement.blur(); }
    });
  </script>
</head>

<body

    <div class="menu_box">
      <div class="green_box">
        Simulations
      </div>
      <div class="container">
        <button class="button" onclick='window.location.href = "./00home.html"'>
          Vehicle
        </button>
      </div>
      <div class="green_box">
        Basic behaviors
      </div>
      <div class="container">
        <button class="button" onclick='window.location.href = "./01seek.html"'>
          Seek
        </button>
      </div>
      <div class="container">
        <button class="button" onclick='window.location.href = "./02flee.html"'>
          Flee
        </button>
      </div>
      <div class="container">
        <button class="button" onclick='window.location.href = "./03arrive.html"'>
          Arrival
        </button>
      </div>
      <div class="container">
        <button class="button" onclick='window.location.href = "./04pursue_evade.html"'>
          Pursue and Evade
        </button>
      </div>
      <div class="container">
        <button class="button" onclick='window.location.href = "./05wander.html"'>
          Wander
        </button>
      </div>
      <div class="container">
        <button class="button" onclick='window.location.href = "./06obstacle_avoid.html"'>
          Obstacle Avoidance
        </button>
      </div>
      <div class="container">
        <button class="button" onclick='window.location.href = "./07containment.html"'>
          Containment
        </button>
      </div>
      <div class="container">
        <button class="button" onclick='window.location.href = "./08wall_follow.html"'>
          Wall Following
        </button>
      </div>
      <div class="container">
        <button class="button" onclick='window.location.href = "./09Path_Following.html"'>
          Path Following
        </button>
      </div>
      <div class="container">
        <button class="button" onclick='window.location.href = "./10flow.html"'>
          Flow Field Following
        </button>
      </div>
      <div class="slider_box">
        Combined behaviors
      </div>
      <div class="container">
        <button class="button" onclick='window.location.href = "./11CrowdPathFollow.html"'>
          Crowd Path Following
        </button>
      </div>
      <div class="container">
        <button class="button" onclick='window.location.href = "./12leader.html"'>
          Leader Following
        </button>
      </div>
      <div class="container">
        <button class="button" onclick='window.location.href = "./13unalignedAvoidence.html"'>
          Unaligned Collision Avoidance
        </button>
      </div>
      <div class="container">
        <button class="button" onclick='window.location.href = "./14queue.html"'>
          Queueing
        </button>
      </div>
      <div class="container">
        <button class="button" onclick='window.location.href = "./15flock.html"'>
          Flocking
        </button>
      </div>
      </nav>
    </div>

    <div class="box">

    <!--BUTTON DISPLAY FORCES-->
    <button id="Forces" class="button">
      Display Forces
    </button>
        
    <!--BUTTON FREEZE-->
    <button id="Freeze" class="button">
      Freeze
    </button>

    </div>

    <div class="main">

        <div class="output_box">
          <span>
            &nbsp;&nbsp;The Queue algorithm checks if in a circle ahead of vehicle is any neighbour.
             If so, then the deceleration is calculated and applied to the vehicle.
              In  emergancy situations, when neighbour will cross circle around vehicle it will brake immediatly and move slowly in a crowd.
              Beside Queue method, Seek is used to give agents vehicles target behind doors, Seperation keeps crowd from overlapping and lastly
              Containment(Generalized Obstacle Avoidance) is used to avoid walls.
              <br>
              &nbsp;&nbsp;The <span style="color:orange">orange</span> vector pointing out of the center of Vehicle is visualization of the desiredVelocity and the <span style="color:#6A5ACD">violet</span>
            one shows current velocity vector.<br>
            &nbsp;&nbsp;If you wish to freeze animation you can also press a spacebar on your keyboard.
          </span>
        </div>

        <canvas id="VP" class="viewport" style="background: #eee; width: 100%;"></canvas>

        <div>
            <div class="range-slider">
                <div class="slider-box">Maxspeed</div>
                <input id="maxspeed" class="range-slider__range" type="range" value="2" min="0" max="7" step="0.01">
                <span class="range-slider__value">0</span>
            </div>
            <div class="range-slider">
                <div class="slider-box">Maxforce</div>
                <input id="maxforce" class="range-slider__range" type="range" value="0.1" min="0" max="5" step="0.01">
                <span class="range-slider__value">0</span>
            </div>
        </div>

        <div>
            <div class="range-slider">
                <div class="slider-box">circle </div>
                <input id="circleAhead" class="range-slider__range" type="range" value="30" min="0" step="0.01">
                <span class="range-slider__value">0</span>
            </div>
            <div class="range-slider">
                <div class="slider-box">Maxforce</div>
                <input id="circleAheadRadius" class="range-slider__range" type="range" value="10" min="0" step="0.01">
                <span class="range-slider__value">0</span>
            </div>
        </div>

        <script>
          var canvas = document.querySelector('.viewport'),
            ctx = canvas.getContext('2d');
          canvas.width = screen.width / 2;
          canvas.height = screen.height / 3;

          // DEFINE AND CREATE WALL OBJECT
          var wall = [];
          wall.push(new objectWall(0, 100, canvas.width / 2 - 35, 100));
          wall.push(new objectWall(canvas.width / 2 - 35, 97, canvas.width / 2 - 30, -50));
          wall.push(new objectWall(canvas.width / 2 + 31, -50, canvas.width / 2 + 30, 97));
          wall.push(new objectWall(canvas.width / 2 + 30, 100, canvas.width, 100));

          //DISPLAY OBJECTS ON CANVAS 
          function drawObjects(Objects) {

            for (let index = 0; index < Objects.length; index++) {

              Objects[index].draw();

            }

          }

          var vehicles = [];
          for (let index = 0; index < 20; index++) {
            vehicles.push(new Vehicle(Math.ceil(300 +( Math.random() * (canvas.width /4))), Math.ceil(Math.random() * 50 + canvas.height)));
            vehicles[vehicles.length - 1].radius = 10;
          }

          var displayForces = 'off';
          document.getElementById("Forces").addEventListener('click', function () {
            if (displayForces == 'on') {
              displayForces = 'off';
            }
            else {
              displayForces = 'on';
            }
          }, false);

          var freeze = "off";
          document.getElementById("Freeze").addEventListener('click', function freezer() {
            if (freeze == 'on') {
              freeze = 'off';
              document.getElementById("Freeze").innerHTML = "Freeze OFF";
            }
            else {
              freeze = 'on';
              document.getElementById("Freeze").innerHTML = "Freeze ON";
            }
          }, false);
          document.body.addEventListener("keypress", function (k) {
            console.log(k.keyCode, k.key, displayForces, freeze)
            if (k.keyCode == 32) {
              if (freeze == 'on') {
                freeze = 'off';
                document.getElementById("Freeze").innerHTML = "Freeze OFF";
              }
              else {
                freeze = 'on';
                document.getElementById("Freeze").innerHTML = "Freeze ON";
              }
            }
          }, false);

          rangeSliderInit();

          var target = new Vector(canvas.width / 2, -100)

          function draw() {
            ctx.setTransform(1, 0, 0, 1, 0, 0); // <- JS magic for PathBegin()..
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            for (let index = 0; index < vehicles.length; index++) {

              if (vehicles[index].position.distanceBetweenPoints(target) < 30) {

                vehicles[index].position.x = Math.ceil(300 +( Math.random() * (canvas.width /4)));
                vehicles[index].position.y = Math.ceil(canvas.height);
              }
              var avoid = vehicles[index].containment(wall);
              var seek = vehicles[index].seek(target.x, target.y,displayForces);
              var sep = vehicles[index].separation(vehicles);
              var brake = vehicles[index].queue(vehicles,
               VehAhead = document.getElementById("circleAhead").value,
               VehRadius = document.getElementById("circleAheadRadius").value,
               displayForces);
              if(avoid.x != 0 || avoid.y != 0){
                var avoidSeek = vehicles[index].seek(avoid.x,avoid.y);
                avoidSeek = avoidSeek.multiply(2);
                vehicles[index].applyForce(avoidSeek);
              }
              seek = seek.multiply(0.3);
              vehicles[index].applyForce(seek);
              vehicles[index].applyForce(sep);
              vehicles[index].applyForce(brake);
              vehicles[index].acceleration = vehicles[index].acceleration.divide(3);
              if (freeze == 'off') {

                vehicles[index].update();

              }

              vehicles[index].renderVehicle();
              vehicles[index].renderForces();
              
              vehicles[index].maxforce = document.getElementById("maxforce").value;
              vehicles[index].maxspeed = document.getElementById("maxspeed").value;
              
            }
                
            drawObjects(wall);

          }
          setInterval(draw, 30);
        </script>

    </div>

    <div class="code_box">

      <!--CREATES SNIPPET OF CODE-->
      <pre class="prettyprint linenums">
queue(Vehicles, VehAhead, VehRadius) {
  var neighbour = null;
  var circleAhead = this.velocity.normalize().multiply(VehAhead);
  circleAhead = this.position.add(circleAhead);
  for (let i = 0; i < Vehicles.length; i++) {
    if ((Vehicles[i].position.distanceBetweenPoints(circleAhead) < VehRadius) &&
      (Vehicles[i].position.distanceBetweenPoints(this.position) != 0)) {
        neighbour = Vehicles[i];
    }
  }
  var brake = new Vector(0,0);
  if (neighbour != null) {
    brake = brake.add(this.velocity.multiply(-0.6));
    if(this.position.distanceBetweenPoints(neighbour.position) <= VehRadius*1.5){
      return this.velocity.multiply(-0.3);
    }
  } 
  return brake;
}</pre>
    </div>
</body>

</html>