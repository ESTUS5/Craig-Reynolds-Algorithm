<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title>Craig-Reynolds Algorithm</title>
    <!--design-->
    <link rel="stylesheet" href="button.css" />
    <link rel="stylesheet" href="box.css" />
    <!--snippet function-->
    <script src="https://cdn.jsdelivr.net/gh/google/code-prettify@master/loader/run_prettify.js"></script>
    <link rel="stylesheet" href="desert.css" />
    <!--mouse function-->
    <script src="https://code.jquery.com/jquery-1.10.2.js"></script>
    <script src="mouse.js"></script>
    <!--main functions-->
    <script src="vector.js"></script>
    <script src="vehicle.js"></script>
    <!--sliders-->
    <script src="sliderStyle.js"></script>
    <link rel="stylesheet" href="sliderStyle.css" />
    <!--object functions -->
    <script src="object.js"></script>
    <!--To disable focusing on Chrome browser -->
    <script type="text/javascript">
        document.addEventListener('click', function (e) {
            if (document.activeElement.toString() == '[object HTMLButtonElement]') { document.activeElement.blur(); }
        });
    </script>
</head>

<body>
  <div class="menu_box">
    <div class="green_box">
      Simulations
    </div>
    <div class="container">
      <button class="button" onclick='window.location.href = "./00home.html"'>
        Vehicle
      </button>
    </div>
    <div class="green_box">
      Basic behaviors
    </div>
    <div class="container">
      <button class="button" onclick='window.location.href = "./01seek.html"'>
        Seek
      </button>
    </div>
    <div class="container">
      <button class="button" onclick='window.location.href = "./02flee.html"'>
        Flee
      </button>
    </div>
    <div class="container">
      <button class="button" onclick='window.location.href = "./03arrive.html"'>
        Arrival
      </button>
    </div>
    <div class="container">
      <button class="button" onclick='window.location.href = "./04pursue_evade.html"'>
        Pursue and Evade
      </button>
    </div>
    <div class="container">
      <button class="button" onclick='window.location.href = "./05wander.html"'>
        Wander
      </button>
    </div>
    <div class="container">
      <button class="button" style="background-color: #333; color: white; cursor: not-allowed;" disabled="disabled" onclick='window.location.href = "./06obstacle_avoid.html"'>
        Obstacle Avoidance
      </button>
    </div>
    <div class="container">
      <button class="button" onclick='window.location.href = "./07containment.html"'>
        Containment
      </button>
    </div>
    <div class="container">
      <button class="button" onclick='window.location.href = "./08wall_follow.html"'>
        Wall Following
      </button>
    </div>
    <div class="container">
      <button class="button" onclick='window.location.href = "./09Path_Following.html"'>
        Path Following
      </button>
    </div>
    <div class="container">
      <button class="button" onclick='window.location.href = "./10flow.html"'>
        Flow Field Following
      </button>
    </div>
    <div class="green_box">
      Combined behaviors
    </div>
    <div class="container">
      <button class="button" onclick='window.location.href = "./11CrowdPathFollow.html"'>
        Crowd Path Following
      </button>
    </div>
    <div class="container">
      <button class="button" onclick='window.location.href = "./12leader.html"'>
        Leader Following
      </button>
    </div>
    <div class="container">
      <button class="button" onclick='window.location.href = "./13unalignedAvoidence.html"'>
        Unaligned Collision Avoidance
      </button>
    </div>
    <div class="container">
      <button class="button" onclick='window.location.href = "./14queue.html"'>
        Queue
      </button>
    </div>
    <div class="container">
      <button class="button" onclick='window.location.href = "./15flock.html"'>
        Flocking
      </button>
    </div>
  </div>

  <div class="box">

        <!--BUTTON DISPLAY FORCES-->
        <button id="Forces" class="button">
            Display Forces
        </button>
        
        <!--BUTTON FREEZE-->
        <button id="Freeze" class="button">
            Freeze
        </button>

    </div>

    <div class="main">

      <div class="explain_box">
        <span>&nbsp;&nbsp;Obstacle Avoidance algorithm is used with unimportantly simple method runAhead(), which applies the agent with the vector with biggest possible length for the agent.
           That vector keeps the agent in motion even when the main method doesn't respond to the enviroment.
          The vehicle tries to move as fast as he can and avoid <span style="color:pink">objects</span> ahead of him.
          Algorithm will calculate normal points of every <span style="color:pink">object</span>, then it will consider only those that are between vehicle position and predicted position.
          If any of selected has radius that overlaps with the <span style="color:rgb(49, 133, 56)">margins</span>, the vector pointing to the mirrored direction will be calculated.
          <span style="color:rgba(59, 116, 238, 0.918)">Braking force</span> will be also applied and scaled down or up accordingly to the distance between vehicle position and <span style="color:pink">object</span>.
          After that the vector can be returned and Seek method can apply it. <br>
          &nbsp;&nbsp;The <span style="color:#FF4500">orange</span> vector pointing out of the center of Vehicle is visualization of the desiredVelocity and the <span style="color:#6A5ACD">violet</span>
          one shows current velocity vector. As mentioned before <span style="color:rgba(59, 116, 238, 0.918)">blue</span> vector represents braking force, and <span style="color:green">green</span> one represents avoidance<br>
          &nbsp;&nbsp;If you wish to freeze animation you can also press a spacebar on your keyboard. If you on the other hand want to change the direction of vehicle just choose point using circle attached to your cursor and keep left mouse button presssed until you your changes satisfy you.<br>
          &nbsp;&nbsp;The average of occuring collisions per step <span id="stat">0</span>
        </span>
      </div>

        <canvas id="VP" class="viewport" style="background: #eee; width: 100%;height: 50%;"></canvas>
        
        <!--OUTPUT OF VEHICLE POSITION & VELOCITY-->
        <div class="output_box">
            Vehicle position x:
            <span id="vehicle_posX"></span>
            y:
            <span id="vehicle_posY"></span>
            velocity:
            <span id="vehicle_vel"></span>

        </div>

        <div>

            <!--RANGE SLIDER OF MAXSPEED-->
            <div class="range-slider">

                <div class="slider-box">Maxspeed</div>

                <div class="container">

                  <input id="maxspeed" class="range-slider__range" type="range" value="2" min="0" max="7" step="0.01">
                  
                  <span class="range-slider__value">0</span>

                </div>
            
            </div>

            <!--RANGE SLIDER OF MAXFORCE-->
            <div class="range-slider">
                
                <div class="slider-box">Maxforce</div>
                
                <div class="container">

                  <input id="maxforce" class="range-slider__range" type="range" value="0.1" min="0" max="5" step="0.01">
                  
                  <span class="range-slider__value">0</span>

                </div>
            
            </div>
        
        </div>

        <div>

            <!--RANGE SLIDER OF LENGHT-->
            <div class="range-slider">

                <div class="slider-box">Length</div>

                <div class="container">

                  <input id="L" class="range-slider__range" type="range" value="100" min="0" max="200" step="0.01">
                  
                  <span class="range-slider__value">0</span>

                </div>
            
            </div>

            <!--RANGE SLIDER OF RADIUS-->
            <div class="range-slider">
                
                <div class="slider-box">Radius</div>
                
                <div class="container">

                  <input id="r" class="range-slider__range" type="range" value="15" min="0" max="200" step="0.01">
                  
                  <span class="range-slider__value">0</span>

                </div>
            
            </div>

        </div>


        <script>

            //CHANGE WIDTH & HEIGHT OF CANVAS
            var canvas = document.querySelector('.viewport'),
                ctx = canvas.getContext('2d');
            canvas.width = screen.width / 2;
            canvas.height = screen.height / 3;

            //READ MOUSE POSITION
            mouseObj.Init("#VP",canvas);

            //READ IF BUTTON "DISPLAY FORCE" WAS CLICKED
            var displayForces = 'off';
            document.getElementById("Forces").addEventListener('click', function () {
                if (displayForces == 'on') {
                    displayForces = 'off';
                }
                else {
                    displayForces = 'on';
                }
            }, false);

            //READ IF BUTTON "FREEZE" WAS CLICKED
            var freeze = "off";
            document.getElementById("Freeze").addEventListener('click', function freezer() {
                if (freeze == 'on') {
                freeze = 'off';
                document.getElementById("Freeze").innerHTML = "Freeze OFF";
                }
                else {
                freeze = 'on';
                document.getElementById("Freeze").innerHTML = "Freeze ON";
                }
            }, false);

            //READ IF BUTTON "FREEZE" WAS KEYPRESSED
            document.body.addEventListener("keypress", function (k) {
                console.log(k.keyCode, k.key, displayForces, freeze)
                if (k.keyCode == 32) {
                if (freeze == 'on') {
                    freeze = 'off';
                    document.getElementById("Freeze").innerHTML = "Freeze OFF";
                }
                else {
                    freeze = 'on';
                    document.getElementById("Freeze").innerHTML = "Freeze ON";
                }
                }
            }, false);

            rangeSliderInit();

            // DEFINE AND FILL ARRAY OF OBJECTS
            var objects = []
            var numOfRandomObj = 80;
            for (let k = 0; k < numOfRandomObj; k++) {
              var randomVector = new Vector(Math.round(Math.random() * canvas.width,2), Math.round(Math.random() * canvas.height,2)),
              randomRadius = 5 + Math.round(Math.random() * 10,2);
              var colliding = false;
              if(objects.length > 0){
                colliding = true;
              }
              while (colliding) {

                  var collisions = 0;

                  for(let i = 0; i < objects.length; i++){

                    if(objects[i][0].distanceBetweenPoints(randomVector) <= (randomRadius + objects[i][1] ) ){
                      collisions++;
                    }

                  }

                  if(collisions > 0){

                    randomVector = new Vector(Math.round(Math.random() * canvas.width,2), Math.round(Math.random() * canvas.height,2)),
                    randomRadius = 5 + Math.round(Math.random() * 15,2);

                  }

                  else{

                      colliding = false;

                  }

              }
              objects.push([randomVector, randomRadius])

            }

            var target = new Vector(0, 0), timeout = 0;
            document.getElementById("VP").addEventListener('mousedown', function () {
                target = new Vector(mouseObj.x, mouseObj.y);
                timeout = 20;
            }, false);

            //INIT VEHICLE
            var vehicle = new Vehicle(10, 10);

            //CHANGE VEHICLE POSITION IF THAT INTERSECTS WITH OBSTACLES
            var colliding = true;
            while (colliding) {

                var collisions = 0;

                for(let i = 0; i < objects.length; i++){

                    if(vehicle.position.distanceBetweenPoints(objects[i][0]) <= objects[i][1]){
                        collisions++;
                    }

                }

                if(collisions>0){

                    vehicle.position.x = Math.ceil(Math.random() * canvas.width);
                    vehicle.position.y = Math.ceil(Math.random() * canvas.height);
                }

                else{

                    colliding = false;

                }

            }
            
            //DISPLAY OBJECTS ON CANVAS 
            function drawObjects(Objects) {
              for (let index = 0; index < Objects.length; index++) {
                ctx = canvas.getContext('2d');
                ctx.beginPath();
                ctx.arc(Objects[index][0].x, Objects[index][0].y, Objects[index][1], 0, 2 * Math.PI);
                ctx.closePath();
                ctx.fillStyle = "rgba(200, 0, 200,0.3)";
                ctx.fill();
              }
            }

            //INITIAL PUSH FOR VEHICLE
            vehicle.velocity.x = vehicle.maxspeed;
            vehicle.velocity.y = vehicle.maxspeed;

            //LOOP FUNC
            var collided = 0, steps = 0;
            function draw() {

                ctx.setTransform(1, 0, 0, 1, 0, 0); // <- JS magic for PathBegin()..
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                vehicle.maxforce = document.getElementById("maxforce").value;
                vehicle.maxspeed = document.getElementById("maxspeed").value;
                vehicle.renderCircleAround(mouseObj.x, mouseObj.y, 5);
                
                var obstacle = vehicle.avoidObstacle(
                  objects,
                  aheadPoint = Math.ceil(document.getElementById("L").value),
                  margin = Math.ceil(document.getElementById("r").value),
                  displayForces = displayForces
                  );

                var force = 0;

                if ( (obstacle.x == 0 && obstacle.y == 0) ) {

                    force = vehicle.runAhead();

                }

                else{

                  force = vehicle.seek(obstacle.x,obstacle.y)

                }

                vehicle.applyForce(force);

                if (timeout > 0) {

                    var seek = vehicle.seek(target.x, target.y);
                    vehicle.applyForce(seek);
                    timeout--;

                }

                if (displayForces == 'on') {

                    vehicle.renderForces();

                }
                
                if (freeze == 'off') {
                    
                    vehicle.update();
                    
                }
                
                

                for (let i = 0; i < objects.length; i++) {
                  if(objects[i][0].distanceBetweenPoints(vehicle.position) < (vehicle.radius + objects[i][1]) ){
                    collided++;
                  }
                }

                steps++;
                document.getElementById("stat").innerHTML = (collided / steps).toFixed(2);

                vehicle.outOfBounds();
                vehicle.renderVehicle();

                drawObjects(objects);

                document.getElementById("snipMargin").innerHTML = Math.ceil(document.getElementById("r").value);
                document.getElementById("snipL").innerHTML = Math.ceil(document.getElementById("L").value);
                $("#vehicle_posX").text(Math.ceil(vehicle.position.x));
                $("#vehicle_posY").text(Math.ceil(vehicle.position.y));
                $("#vehicle_vel").text((vehicle.velocity.length()).toFixed(2));
            }
            setInterval(draw, 50);
        </script>
        
    </div>

    <div class="code_box">
      <!--CREATES SNIPPET OF CODE-->
      <pre class="prettyprint linenums">
avoidObstacle(objects, aheadPoint = <b id="snipL" style="color: #cd5c5c">100</b>, margin = <b id="snipMargin" style="color: #cd5c5c">15</b>) {
  var predictPoint = this.velocity.normalize();
  predictPoint = predictPoint.multiply(aheadPoint);
  predictPoint = this.position.add(predictPoint);
  var smallestDistance = predictPoint.distanceBetweenPoints(this.position);
  var closestObj = new Vector(0, 0), closestNormalPoint = new Vector(0, 0);
  for (let i = 0; i < objects.length; i++) {
    var normalPointObj = objects[i][0].normalPoint(this.position,
     predictPoint);
    if(normalPointObj.isBetween(this.position, predictPoint) == true) {
      if(normalPointObj.distanceBetweenPoints(objects[i][0]) <
        objects[i][1] + margin){
        if(normalPointObj.distanceBetweenPoints(this.position) <
           smallestDistance) {
          smallestDistance = normalPointObj.distanceBetweenPoints(this.position);
          closestObj = objects[i][0];
          closestNormalPoint = normalPointObj;
        }
      }
    }
  }
  var mirrorTarget = closestObj.mirror(closestNormalPoint);
  //BrakingForce
  var brakeVector = new Vector(0,0);
  if(mirrorTarget.x != 0 || mirrorTarget.y != 0){
    var d = this.position.distanceBetweenPoints(closestNormalPoint);
    var brake = this.velocity.map(d,this.maxspeed,0,aheadPoint,0);
    brakeVector = this.velocity.normalize().multiply(-(this.maxspeed - brake));
  }
  return mirrorTarget.add(brakeVector);
}</pre>
    </div>
</body>

</html>