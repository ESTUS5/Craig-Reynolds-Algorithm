<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />
  <title>Craig-Reynolds Algorithm</title>
  <link rel="stylesheet" href="sliderStyle.css" />
  <link rel="stylesheet" type="text/css" href="desert.css" />
  <link rel="stylesheet" href="pagesLayoutStyle.css" />
  <link rel="stylesheet" href="button.css" />
  <script src="https://code.jquery.com/jquery-1.10.2.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/google/code-prettify@master/loader/run_prettify.js"></script>
  <script src="vector.js"></script>
  <script src="mouse.js"></script>
  <script src="vehicle.js"></script>
  <script src="sliderStyle.js"></script>
  <!--To disable focusing on Chrome browser -->
  <script type="text/javascript">
    document.addEventListener('click', function (e) {
      if (document.activeElement.toString() == '[object HTMLButtonElement]') { document.activeElement.blur(); }
    });
  </script>
  <script src="path.js"></script>
</head>

<body
  style=" background-color: hsl(117, 43%, 80%);margin-right:0;padding-right:0;margin-left: 0px; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif; font-size: 16px">

  <div class="box" style="float: left; width: auto vw; font-size: 90%; height: auto;">
    <div class="box" style="color: black; background: #53d8cd;width: 95%;height: 90%;text-align: center;
          margin-left: 0px;padding-left: 0px;padding-right: 0px;margin-bottom: 8px;">
      Simulations
    </div>

    <div class="container">
      <button class="button" onclick='window.location.href = "./00home.html"'>
        Vehicle
      </button>
    </div>

    <div class="box" style="color: black; background: #53d8cd;width: 90%;height: 90%;text-align: center;
                  margin-left: 0px;padding-left: 0px;padding-right: 0px;margin-bottom: 5px;margin-top: 5px;">
      Basic behaviors
    </div>

    <div class="container">
      <button class="button" onclick='window.location.href = "./01seek.html"'>
        Seek
      </button>
    </div>
    <div class="container">
      <button class="button" onclick='window.location.href = "./02flee.html"'>
        Flee
      </button>
    </div>
    <div class="container">
      <button class="button" onclick='window.location.href = "./03arrive.html"'>
        Arrival
      </button>
    </div>
    <div class="container">
      <button class="button" onclick='window.location.href = "./04pursue_evade.html"'>
        Pursue and Evade
      </button>
    </div>
    <div class="container">
      <button class="button" onclick='window.location.href = "./05wander.html"'>
        Wander
      </button>
    </div>
    <div class="container">
      <button class="button" onclick='window.location.href = "./06obstacle_avoid.html"'>
        Obstacle Avoidance
      </button>
    </div>
    <div class="container">
      <button class="button" onclick='window.location.href = "./07containment.html"'>
        Containment
      </button>
    </div>
    <div class="container">
      <button class="button" onclick='window.location.href = "./08wall_follow.html"'>
        Wall Following
      </button>
    </div>
    <div class="container">
      <button class="button" onclick='window.location.href = "./09Path_Following.html"'>
        Path Following
      </button>
    </div>
    <div class="container">
      <button class="button" onclick='window.location.href = "./10flow.html"'>
        Flow Field Following
      </button>
    </div>

    <div class="box" style="color: black; background: #53d8cd;width: 90%;height: 90%;text-align: center;
                  margin-left: 0px;padding-left: 0px;padding-right: 0px;margin-bottom: 5px;
                  margin-top: 5px;">
      Combined behaviors
    </div>
    <div class="container">
      <button class="button" onclick='window.location.href = "./11CrowdPathFollow.html"'>
        Crowd Path Following
      </button>
    </div>
    <div class="container">
      <button class="button" onclick='window.location.href = "./12leader.html"'>
        Leader Following
      </button>
    </div>
    <div class="container">
      <button class="button" onclick='window.location.href = "./13unalignedAvoidence.html"'>
        Unaligned Collision Avoidance
      </button>
    </div>
    <div class="container">
      <button class="button" onclick='window.location.href = "./14queue.html"'>
        Queueing
      </button>
    </div>
    <div class="container">
      <button class="button" onclick='window.location.href = "./15flock.html"'>
        Flocking
      </button>
    </div>
    </nav>
  </div>

  <div id="backToHome" class="container" style=" display: inline-block;">

    <!--BUTTON DISPLAY FORCES-->
    <button id="Forces" class="button">
      Display Forces
    </button>
    
    <!--BUTTON FREEZE-->
    <button id="Freeze" class="button">
      Freeze
    </button>

  </div>

  <div id="main" class="container" style="display: inline-block;width: 50vw;padding-right: 0px;">

      <div class="box" style="width: 90%;height:  auto;text-align: left;
      margin-bottom: 5px;">
      <span>
        &nbsp;&nbsp;Crowd Path following is supposingly an example of human crowd walking through corridor. Only two methods are combined to achieve this effect.
        First was already described as Path following algorithm and here it is used the same way. Second method is new and requires other vehicles to work properly.
         It is called Separation and is quite simple. After it finds every neighbour's position, it makes average of it and then inverses the vector.
         When it is applied the vehicle will be separating itself from the biggest group of neighbours. 
        <br>
        &nbsp;&nbsp;The <span style="color:orange">orange</span> vector pointing out of the center of Vehicle is visualization of the desiredVelocity and the <span style="color:#6A5ACD">violet</span>
        one shows current velocity vector.<br>
        &nbsp;&nbsp;If you wish to freeze animation you can also press a spacebar on your keyboard.
      </span>
    </div>

    <canvas id="VP" class="viewport" style="background: #eee; width: 100%; position: relative;height: 50%;"></canvas>
    
    <div>

      <!--RANGE SLIDER OF MAXSPEED-->
      <div class="range-slider" style="float: left;margin-top: 20px;margin-bottom: 20px;width: 50% ;">

        <div class="box" style="margin:0px; top:4px">Maxspeed</div>
        
        <input id="maxspeed" class="range-slider__range" type="range" value="2" min="0" max="7" step="0.01">
        
        <span class="range-slider__value" style="top:4px">0</span>
      
      </div>

      <!--RANGE SLIDER OF MAXFORCE-->
      <div class="range-slider" style="float: left;margin-top: 20px;margin-bottom: 20px;width: 50% ;">
        
        <div class="box" style="margin:0px; top:4px">Maxforce</div>
        
        <input id="maxforce" class="range-slider__range" type="range" value="0.1" min="0" max="5" step="0.01">
        
        <span class="range-slider__value" style="top:4px">0</span>
      
      </div>

    </div>

    <div>

      <!--RANGE SLIDER OF PREDICT DISTANCE-->
      <div class="range-slider" style="float: left;margin-top: 20px;margin-bottom: 20px;width: 50% ;">
        
        <div class="box" style="margin:0px; top:4px">Predict distance</div>
        
        <input id="Predict" class="range-slider__range" type="range" value="30" min="0">
        
        <span class="range-slider__value" style="top:4px">0</span>
      
      </div>
      
      <!--RANGE SLIDER OF TARGET OFFSET-->
      <div class="range-slider" style="float: left;margin-top: 20px;margin-bottom: 20px;width: 50% ;">
        
        <div class="box" style="margin:0px; top:4px">Target offset</div>
        
        <input id="Target" class="range-slider__range" type="range" value="10" min="0">
        
        <span class="range-slider__value" style="top:4px">0</span>
      
      </div>

    </div>

    <div>

        <!--RANGE SLIDER OF SEPARATION FORCE-->
        <div class="range-slider" style="float: left;margin-top: 20px;margin-bottom: 20px;width: 50% ;">
          
            <div class="box" style="margin:0px; top:4px">Separation Force</div>
            
            <input id="sepF" class="range-slider__range" type="range" value="0.5" min="0" max="5" step="0.01">
            
            <span class="range-slider__value" style="top:4px">0</span>
          
          </div>
  
      </div>

    <script>

      //CHANGE WIDTH & HEIGHT OF CANVAS
      var canvas = document.querySelector('.viewport'),
        ctx = canvas.getContext('2d');
      canvas.width = screen.width / 2;
      canvas.height = screen.height / 2.5;

      //INIT PATH
      var path = new Path(canvas.width/4, 70, canvas.width/1.75, 40,30);
      path.addPoint(canvas.width*0.80, canvas.height/3);
      path.addPoint(canvas.width -50,canvas.height/3 );
      path.addPoint(canvas.width-80, canvas.height*0.8);
      path.addPoint(40, canvas.height*0.8);
      path.addPoint(60, 80);
      path.addPoint(canvas.width/4,70);

      //INIT VEHICLES (ARRAY)
      var vehicles = [];
      for (let index = 0; index < 200; index++) {
          vehicles.push(new Vehicle(Math.ceil(Math.random()*canvas.width) ,Math.ceil(Math.random()*canvas.height)));
          vehicles[vehicles.length-1].radius = 5;
          vehicles[vehicles.length-1].choosePath(path.points, path.radius);
      }

      //READ IF BUTTON "DISPLAY FORCE" WAS CLICKED
      var displayForces = 'off';
      document.getElementById("Forces").addEventListener('click', function () {
        if(displayForces == 'on'){
            displayForces = 'off';
        }
        else{
            displayForces = 'on';
        }
      }, false);

      //READ IF BUTTON "FREEZE" WAS CLICKED
      var freeze = "off";
      document.getElementById("Freeze").addEventListener('click', function freezer() {
        if (freeze == 'on') {
          freeze = 'off';
          document.getElementById("Freeze").innerHTML = "Freeze OFF";
        }
        else {
          freeze = 'on';
          document.getElementById("Freeze").innerHTML = "Freeze ON";
        }
      }, false);

      //READ IF BUTTON "FREEZE" WAS KEYPRESSED
      document.body.addEventListener("keypress", function (k) {
        console.log(k.keyCode, k.key, displayForces, freeze)
        if (k.keyCode == 32) {
          if (freeze == 'on') {
            freeze = 'off';
            document.getElementById("Freeze").innerHTML = "Freeze OFF";
          }
          else {
            freeze = 'on';
            document.getElementById("Freeze").innerHTML = "Freeze ON";
          }
        }
      }, false);

      rangeSliderInit();

      //LOOP FUNC
      function draw() {

        ctx.setTransform(1, 0, 0, 1, 0, 0); // <- JS magic for PathBegin()..
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        for (let index = 0; index < vehicles.length; index++) {

            var follow = vehicles[index].followPath(document.getElementById("Predict").value,
            document.getElementById("Target").value,displayForces);

          var seek = vehicles[index].seek(follow.x,follow.y);

          var sep = vehicles[index].separation(vehicles);
            if(sep != null ){
              sep = sep.multiply(document.getElementById("sepF").value);
              vehicles[index].applyForce(sep);
            }

            if (follow.x != 0 || follow.y != 0) {
              var seek = vehicles[index].seek(follow.x,follow.y);
              vehicles[index].applyForce(seek);
            }

            if (freeze == 'off') {

              vehicles[index].update();

            }

            if(displayForces == "on"){
              vehicles[index].renderForces();
            }

            vehicles[index].renderVehicle();

            document.getElementById("snipSep").innerHTML = document.getElementById("sepF").value;
            vehicles[index].maxforce = document.getElementById("maxforce").value;
            vehicles[index].maxspeed = document.getElementById("maxspeed").value;

        }

        path.draw();

      }

      setInterval(draw, 14);

    </script>

  </div>

  <div id="codeSnippet" class="box" style="text-align: left; display: inline-block; padding-right: 0;margin-right: 0;width:32.5vw;">

      <!--CREATES SNIPPET OF CODE-->
      <pre class="prettyprint linenums"
        style="font-size:90%;position: inherit;margin-top: 2px;margin-bottom: 2px; font-family:-apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;">
separation(Vehicles) {
  var desired_seperation = this.radius * 2;
  var sumVector = new Vector(0, 0);
  var j = 0;
  for (let i = 0; i < Vehicles.length; i++) {
    var distance = this.position.distanceBetweenPoints(Vehicles[i].position);
    if ((distance > 0) && (distance < desired_seperation)) {
      var differance = this.position.subtract(Vehicles[i].position);
      differance = differance.normalize();
      differance = differance.divide(distance);
      sumVector = sumVector.add(differance);
      j++;
    }
  }
  if (j > 0) {
    sumVector = sumVector.divide(j);
    sumVector = sumVector.normalize();
    sumVector = sumVector.multiply(this.maxspeed);
    var steer = sumVector.subtract(this.velocity);
    return steer;
  }
}
//USE OF SEPARATION
function draw() {
  for (let index = 0; index < vehicles.length; index++) {
    car follow = vehicles[index].followPath();
    var sep = vehicles[index].separation(vehicles);
    sep = sep.multiply(<b id="snipSep" style="color: #cd5c5c">0.5</b>);
    vehicles[index].applyForce(sep);
    vehicles[index].applyForce(follow);
    vehicles[index].update();
    vehicles[index].renderVehicle();
}</pre>

  </div>

</body>

</html>